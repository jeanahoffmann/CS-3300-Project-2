<html>

<head>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <style>
    * {
      font-family: "Inter", sans-serif;
    }

    body {
      margin-top: 40px;
      background-color: black;
      color: white;
    }

    h3 {
      margin-top: 40px;
    }

    .myCircle:hover {
      stroke: black;
    }

    .gridlines .domain {
      display: none;
    }

    .gridlines line {
      stroke: #aaa;
    }
  </style>
</head>

<body>
  <h3>CS 3300 Project 2: Simon Tian, Colin Wu, and Jeana Hoffmann</h3>
  <svg id="choropleth" height="800" width="1000"></svg>
  <ul id="legend"></ul>
  <script>
    let choropleth = d3.select('svg#choropleth');
    const mapHeight = choropleth.attr('height');
    const mapWidth = choropleth.attr('width');

    const requestChoropleth = async function () {
      let nyc = await d3.json('data/nyc_zips.topo.json');
      let crashData = await d3.csv('data/zip_crashes.csv', d3.autoType);
      console.log(nyc);
      console.log(crashData);

      let zips = topojson.feature(nyc, nyc.objects["nyc-zip-code-tabulation-areas-polygons"]);
      let zipsMesh = topojson.mesh(nyc, nyc.objects["nyc-zip-code-tabulation-areas-polygons"]);
      let projection = d3.geoMercator().fitSize([mapWidth, mapHeight], zips);
      let path = d3.geoPath().projection(projection);

      plasma = d3.interpolatePlasma
      let colors = [plasma(0), plasma(0.25), plasma(0.5), plasma(0.75), plasma(1)];
      crashExtent = d3.extent(crashData, d => d['CRASHES']);
      let colorScale = d3.scaleQuantile(colors).domain(crashExtent);

      let crashMap = {};
      crashData.forEach(function (d) {
        crashMap[d['ZIP CODE']] = d['CRASHES'];
      });


      let map = choropleth.append('g');
      map.selectAll('path.zip').filter((d) => d.uniqueId === 12345)
        .data(zips.features)
        .join("path")
        .attr('fill', d => colorScale(crashMap[d.properties['postalCode']]))
        .attr("d", path)
        .on('mouseover', mouseEntersZip)
        .on('mouseout', mouseLeavesZip);

      map.append('path')
        .datum(zipsMesh)
        .attr('class', 'outline')
        .attr('fill', 'none')
        .attr('stroke', 'black')
        .attr('stroke-width', 1)
        .attr('d', path);

      let momesh = map.append("path")
        .attr("class", "outline")
        .attr('fill', 'none')
        .style("stroke", "white")
        .style("stroke-width", 3)
        .attr("d", "");

      function mouseEntersZip() {
        let zip = d3.select(this);
        zipID = zip.datum().id

        var mo = topojson.mesh(nyc, nyc.objects["nyc-zip-code-tabulation-areas-polygons"], function (a, b) { return a.id === zipID || b.id === zipID; });
        //  Then apply it to your special mesh that's on top of everything else (added earlier in this file)
        momesh.datum(mo).attr("d", path)
      }
      function mouseLeavesZip() {
        let zip = d3.select(this);

        momesh.attr("d", "");
      }
    }

    requestChoropleth();
  </script>

</body>

</html>